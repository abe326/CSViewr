# CSV Viewer Application

CSVファイルを読み込んで表示・編集するためのWebアプリケーションです。メインとなるCSVファイルと、それに関連する連携用CSVファイルを結合して表示することができます。

## 設定方法

設定は`index.html`ファイル内の`<script id="app-config" type="application/json">`タグで行います。

### 基本構造

```json
{
  "gridConfig": {
    "gridColumns": [ ... ]  // グリッド表示の列設定
  },
  "detailConfig": {
    "detailColumns": [ ... ]  // 詳細表示の列設定
  },
  "mergeConfig": {
    "mainKey": "氏名",  // メインCSVのキー列
    "linkedKey": "氏名",  // 連携CSVのキー列
    "mergeColumns": ["部署", "役職", "ステータス"]  // 連携CSVから値を取得する列
  }
}
```

### 列の設定項目

#### グリッド表示の列設定（gridColumns）

| プロパティ | 型 | 説明 | 必須 |
|------------|-----|------|------|
| key | string | 列のキー（CSVのヘッダー名） | ○ |
| displayName | string | 表示名 | ○ |
| width | string | 列の幅（例: "150px"） | - |
| visible | boolean | 表示/非表示 | ○ |
| sortable | boolean | ソート可能にするか | - |
| filterable | boolean | フィルター可能にするか | - |
| isKey | boolean | キー列として使用するか | - |
| clickable | boolean | クリック可能にするか | - |
| formatter | string | 表示形式の変換関数 | - |
| mergeFromLinked | boolean | 連携CSVの値を使用するか | - |

#### 詳細表示の列設定（detailColumns）

| プロパティ | 型 | 説明 | 必須 |
|------------|-----|------|------|
| key | string | 列のキー（CSVのヘッダー名） | ○ |
| displayName | string | 表示名 | ○ |
| visible | boolean | 表示/非表示 | ○ |
| formatter | string | 表示形式の変換関数 | - |

### 設定例

```json
{
  "gridConfig": {
    "gridColumns": [
      {
        "key": "氏名",
        "displayName": "氏名",
        "width": "150px",
        "sortable": true,
        "filterable": true,
        "visible": true,
        "isKey": true,
        "clickable": true
      },
      {
        "key": "部署",
        "displayName": "部署",
        "width": "150px",
        "sortable": true,
        "filterable": true,
        "visible": true,
        "mergeFromLinked": true
      }
    ]
  }
}
```

## 主な機能と使い方

### 1. キー列の設定

キー列は以下の2つの方法で設定できます：

1. 列設定で`isKey: true`を指定
2. `mergeConfig`の`mainKey`と`linkedKey`で指定

キー列は自動的にクリック可能になり、クリックすると詳細画面が表示されます。

### 2. データの結合方法

#### 基本的な結合
- メインCSVと連携CSVは、`mergeConfig`で指定されたキー列の値が一致するレコードが結合されます
- キー列の比較時は以下の正規化が行われます：
  - 全角・半角の統一
  - 大文字・小文字の統一

#### 列の結合機能

複数の列を1つの列に結合して表示することができます。以下のように設定します：

```json
{
  "key": "フルネーム",
  "displayName": "フルネーム",
  "width": {
    "min": "150px",
    "max": "300px",
    "default": "200px"
  },
  "visible": true,
  "combine": {
    "columns": ["姓", "名"],
    "delimiter": " "
  }
}
```

- `combine.columns`: 結合する列のキーを配列で指定
- `combine.delimiter`: 結合時の区切り文字（省略時は半角スペース）

結合された列は、グリッド表示と詳細表示の両方で正しく表示されます。

### 3. 特殊な表示形式

#### 日時のフォーマット
```json
{
  "key": "更新日時",
  "formatter": "(value) => new Date(value).toLocaleString()"
}
```

#### URLリンクの設定
```json
{
  "key": "URL",
  "displayName": "リンク",
  "formatter": "(value) => `<a href=\"${value}\" target=\"_blank\" rel=\"noopener noreferrer\">${value}</a>`"
}
```

または、リンクテキストを変更する場合：
```json
{
  "key": "URL",
  "displayName": "リンク",
  "formatter": "(value) => `<a href=\"${value}\" target=\"_blank\" rel=\"noopener noreferrer\">リンクを開く</a>`"
}
```

#### 改行の扱い
- グリッド表示：改行はスペースに変換されます
- 詳細表示：改行はそのまま表示されます

## 注意事項

1. CSVファイルのヘッダー名は、設定ファイルの`key`と完全に一致する必要があります
2. 日時データは`YYYY-MM-DD HH:mm:ss`形式である必要があります
3. 連携CSVファイルは任意です（指定しなくても動作します）

## 特徴

- 複数のCSVファイルを結合して表示
- カスタマイズ可能な列表示（表示/非表示、幅調整）
- 日本語対応のソート・フィルタリング機能
- モダンなUIデザイン
- レスポンシブ対応

## 仕様

- メインCSVとリンクCSVの2つのファイルを結合して表示
- 指定したキー列（例：ID）でデータを紐付け
- 同じキーを持つレコードの値が異なる場合、カンマ区切りで結合表示
- 列の表示/非表示、幅、ソート、フィルタリングの設定が可能
- 日本語のソートとフィルタリングに対応

## 使用ライブラリ・ライセンス

- React
- TypeScript
- Tailwind CSS
- Vite
- Vitest
- React Testing Library
- PapaParse (CSVパース処理)

ライセンス: MIT

## CSVファイルの仕様と制限

### 特殊文字のエスケープ処理

アプリケーションは内部でPapaParseライブラリを使用してCSVファイルを解析しています。このライブラリは以下の特殊文字を自動的にエスケープ処理します：

1. 基本的なエスケープルール：
   - データ全体をダブルクォーテーション（`"`）で囲む
   - データ内のダブルクォーテーション（`"`）は `""` でエスケープ
   - カンマ（`,`）を含むデータは必ずダブルクォーテーションで囲む

2. 改行を含むデータの場合：
   - データ全体をダブルクォーテーションで囲む
   - データ内の以下の文字をエスケープする：
     - バックスラッシュ（`\`）→ `\\`
     - 特殊記号（`!@#$%^&*()_+-=<>,./?:;'"{}[]|`）→ 前にバックスラッシュを付加
     - データ内のダブルクォーテーション（`"`）→ `""`

#### エスケープ処理の対象となる文字

アプリケーションは以下のような特殊文字を含むデータを適切に処理します：

1. 改行文字（`\n`, `\r\n`）
2. カンマ（`,`）
3. ダブルクォーテーション（`"`）
4. バックスラッシュ（`\`）
5. 特殊記号（`!@#$%^&*()_+-=<>,./?:;'"{}[]|`）
6. 全角・半角カタカナ
7. 特殊な漢字や記号
8. 絵文字やサロゲートペア文字
9. 国際通貨記号（`¢£¬‖−〜―`）
10. 空白文字（スペース、タブ、改行など）

#### エスケープ例

```csv
氏名,部署,役職
"山田太郎","営業部",部長
"田中
美咲","総務\!部\@課",主任
"渡辺正男","営業 \!@#$%^&*()_+-=<>,./?:;\""'{}[]|test
推進部",部長
```

#### エスケープが必要な場合

1. 改行を含むデータ：
```csv
"first
line","second
line"
```

2. 特殊記号を含むデータ：
```csv
"部署!課","営業@本部","開発#グループ"
```

3. 引用符を含むデータ：
```csv
"山田""太郎""","営業部"
```

4. 複合的なケース：
```csv
"開発
第\!1\@課","プロジェクト""A""
チーム"
```

### エスケープ処理の注意点

1. データの先頭と末尾のダブルクォーテーションは、データを囲むために使用し、エスケープしない
2. データ内部のダブルクォーテーションは必ずエスケープする
3. 改行を含むデータでは、特殊記号も必ずエスケープする
4. カンマを含むデータは、必ずダブルクォーテーションで囲む
5. エスケープ漏れがあると、データの表示が崩れる可能性がある

### 改行を含むデータの取り扱い

- CSVファイル内の改行を含むデータは、必ずダブルクォーテーション（`"`）で囲む必要があります
  ```csv
  id,name,description
  1,"山田
  太郎","複数行の
  説明文"
  ```

- 表示方法
  - 一覧画面: 改行は削除され、1行で表示されます
  - 詳細画面: 改行が適用され、複数行で表示されます

### 結合キーについて

- 結合キー（mainKey, linkedKey）は日本語の列名でも指定可能です
- 結合用CSVファイルのキー列は1列目である必要はありません
- キー列以外の全ての列のデータが結合されます
- 同じキーを持つレコードの値が異なる場合、カンマ区切りで結合表示されます

#### サンプルCSVファイル

**メインCSV（main.csv）**:
```csv
社員番号,氏名,部署,役職,ステータス,更新日時
1001,"山田
太郎",営業部,部長,在籍,2023-01-01 10:00:00
1002,鈴木一郎,開発部,課長,在籍,2023-01-01 10:00:00
1003,佐藤次郎,人事部,次長,休職,2023-01-01 10:00:00
1004,田中美咲,総務部,主任,在籍,2023-01-01 10:00:00
1005,高橋健一,営業部,課長,在籍,2023-01-01 10:00:00
```

**リンクCSV（linked.csv）**:
```csv
部署,役職,社員番号,ステータス,更新日時
営業部,次長,1001,在籍,2023-02-01 15:30:00
開発部,課長,1002,在籍,2023-02-01 15:30:00
人事部,次長,1003,復職,2023-02-01 15:30:00
総務部,主任,1004,在籍,2023-02-01 15:30:00
営業部,課長,1005,休職,2023-02-01 15:30:00
```

この例では：
- メインCSVの「社員番号」とリンクCSVの「社員番号」を結合キーとして使用
- キー列は1列目ではありません（メインCSVでは1列目、リンクCSVでは3列目）
- 同じ社員番号のレコードで値が異なる場合（例：佐藤次郎のステータスが「休職」→「復職」）、カンマ区切りで結合表示されます
- 改行を含むデータ（山田太郎の氏名）はダブルクォーテーションで囲まれています

### CSVファイルの要件

- 文字コード: UTF-8
- 区切り文字: カンマ（`,`）
- 改行コード: CR+LF（`\r\n`）またはLF（`\n`）
- 特殊文字を含むセルはダブルクォーテーションで囲む
  - 改行（`\n`, `\r\n`）
  - カンマ（`,`）
  - ダブルクォーテーション（`"`）→ `""`でエスケープ
  - バックスラッシュ（`\`）
  - パーセント記号（`%`）

## 注意事項／既知の制限

- 大規模なCSVファイル（10,000行以上）の処理には時間がかかる場合があります
- ブラウザのメモリ制限により、非常に大きなファイルは処理できない場合があります
- 特殊文字を含むCSVファイルは正しく解析されない場合があります

## ディレクトリ構成

```
CSVtoGRID/
├── public/              # 静的ファイル
├── src/                 # ソースコード
│   ├── components/      # Reactコンポーネント
│   │   ├── __tests__/   # テストファイル
│   ├── utils/           # ユーティリティ関数
│   ├── types/           # 型定義
│   ├── App.tsx          # メインアプリケーション
│   └── main.tsx         # エントリーポイント
├── package.json         # 依存関係
├── tsconfig.json        # TypeScript設定
└── vite.config.ts       # Vite設定
```

## 開発者向け情報

### 開発環境のセットアップ

```bash
# リポジトリのクローン
git clone https://github.com/yourusername/CSVtoGRID.git
cd CSVtoGRID

# 依存関係のインストール
npm install

# 開発サーバーの起動
npm run dev

# テストの実行
npm test

# ビルド
npm run build
```

### テスト

テストはVitestとReact Testing Libraryを使用しています。コンポーネントのテストは`src/components/__tests__/`ディレクトリにあります。

### コード規約

- TypeScriptの型定義を適切に使用すること
- コンポーネントは関数コンポーネントとReact Hooksを使用すること
- テストは主要な機能をカバーすること
- コメントは日本語で記述すること 

### フォーマッター

以下のフォーマッターが利用可能です：

#### url
URLを自動的にリンク化します。空の値や無効なURLの場合は何も表示しません。

```json
{
  "key": "ウェブサイト",
  "displayName": "ウェブサイト",
  "formatter": "(value) => value ? `<a href=\"${value}\" target=\"_blank\" rel=\"noopener noreferrer\">リンクを開く</a>` : ''",
  "visible": true
}
```

#### customUrl
テキストとURLを分けて表示します。`|`で区切って指定します。

```json
{
  "key": "リンク",
  "displayName": "リンク",
  "formatter": "customUrl",
  "visible": true
}
```

データ例：`"会社ウェブサイト|https://example.com"`

#### date
日付を`yyyy/mm/dd`形式に整形します。

```json
{
  "key": "更新日時",
  "displayName": "更新日時",
  "formatter": "date",
  "visible": true
}
```

#### multiline
改行を保持して表示します。グリッド表示では改行を空白に変換し、詳細表示では改行を保持します。

```json
{
  "key": "備考",
  "displayName": "備考",
  "formatter": "multiline",
  "visible": true
}
```

### コンポーネント構成

アプリケーションは以下のコンポーネントで構成されています：

#### App.tsx
- アプリケーションのメインコンポーネント
- 設定の読み込みと状態管理
- ファイルアップロードとデータ処理の制御

#### FileUploadArea.tsx
- CSVファイルのアップロード機能
- メインCSVと連携CSVの個別アップロード
- ドラッグ&ドロップ対応
- アップロードされたファイルの一覧表示と削除機能

#### DataGrid.tsx
- CSVデータのグリッド表示
- ソート機能
- フィルター機能
- 行のクリックによる詳細表示
- カスタムフォーマッターによる表示制御

#### DetailModal.tsx
- レコードの詳細表示
- 改行を保持した表示
- カスタムフォーマッターによる表示制御
- モーダルウィンドウでの表示

#### Layout.tsx
- アプリケーションの共通レイアウト
- ヘッダー、メインコンテンツ、フッターの構成
- レスポンシブデザイン対応 

## ライセンス

本プロジェクトは、以下のオープンソースライブラリを使用しています：

- DOMPurify (Apache License 2.0 / Mozilla Public License 2.0)
- PapaParse (MIT License)
- Lucide-React (ISC License)
- React (MIT License)

詳細なライセンス情報は[LICENSES/README.md](LICENSES/README.md)を参照してください。 